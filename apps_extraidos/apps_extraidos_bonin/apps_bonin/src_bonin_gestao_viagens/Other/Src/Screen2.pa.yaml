# ************************************************************************************************
# Warning: YAML source code for Canvas Apps should only be used to review changes made within Power Apps Studio and for minor edits (Preview).
# Use the maker portal to create and edit your Power Apps.
# 
# The schema file for Canvas Apps is available at https://go.microsoft.com/fwlink/?linkid=2304907
# 
# For more information, visit https://go.microsoft.com/fwlink/?linkid=2292623
# ************************************************************************************************
Screens:
  Screen2:
    Properties:
      LoadingSpinnerColor: =RGBA(45, 65, 93, 1)
      OnVisible: |
        =// 1. Buscar o(s) colaborador(es) relacionado(s) ao usu√°rio logado
        ClearCollect(
            colRegistroColaborador,
            Filter(
                bgv_viajantes,
                email = User().Email
            ).ID_Referencia
        );
        // 2. Buscar todos os registros de viagens feitos por esse(s) colaborador(es)
        Clear(colRegistroViagens);
        ForAll(
            colRegistroColaborador As ref,
            ForAll(
                Filter(bgv_viagens, ID_Referencia = ref.ID_Referencia) As viagem,
                If(
                    IsBlank(
                        LookUp(
                            colRegistroViagens,
                            ID = viagem.ID
                        )
                    ),
                    Collect(colRegistroViagens, viagem)
                )
            )
        )
    Children:
      - app_cpn_bonin_2:
          Control: CanvasComponent
          ComponentName: app_cpn_bonin
          Properties:
            EntradaMenu: =gblFecharMenu
            Fill: =RGBA(87, 107, 134, 1)
            Height: =918
            ListaDasTelas: =colTelas
            ListaIcones: =ColLogo
            Width: =1920
      - ctn_dados_2:
          Control: GroupContainer@1.3.0
          Variant: ManualLayout
          Properties:
            BorderStyle: =BorderStyle.None
            DropShadow: =DropShadow.None
            Height: =app_cpn_bonin_2.Referencia_Height
            RadiusBottomLeft: =app_cpn_bonin_2.Referencia_RadiusBottomLeft
            RadiusBottomRight: =app_cpn_bonin_2.Referencia_RadiusBottomRight
            RadiusTopLeft: =app_cpn_bonin_2.Referencia_RadiusTopLeft
            RadiusTopRight: =app_cpn_bonin_2.Referencia_RadiusTopRight
            Width: =app_cpn_bonin_2.Referencia_Width
            X: =app_cpn_bonin_2.Eixo_X
            Y: =app_cpn_bonin_2.Eixo_Y
          Children:
            - glr_historico:
                Control: Gallery@2.15.0
                Variant: VariableHeight
                Properties:
                  Height: =Parent.Height
                  Items: =SortByColumns(colRegistroViagens, "data_inicio", SortOrder.Descending)
                  TemplatePadding: =0
                  Width: =Parent.Width
                Children:
                  - ctn_historico:
                      Control: GroupContainer@1.3.0
                      Variant: ManualLayout
                      Properties:
                        Fill: =RGBA(144, 157, 175, 1)
                        Height: =htmltxt_historico.Height + If(htmltxt_historico_viajantes_1.Visible, htmltxt_historico_viajantes_1.Height, 0)
                        Width: =Parent.Width
                      Children:
                        - htmltxt_historico_viajantes_1:
                            Control: HtmlViewer@2.1.0
                            Properties:
                              AutoHeight: =true
                              Height: =50
                              HtmlText: =First(colResumoVisualizacao).HtmlCompleto
                              OnSelect: =
                              Visible: =varHistoricoExpandido = ThisItem.ID_Referencia
                              Width: =Parent.Width
                              Y: =htmltxt_historico.Y + htmltxt_historico.Height
                        - htmltxt_historico:
                            Control: HtmlViewer@2.1.0
                            Properties:
                              AutoHeight: =true
                              Height: =151
                              HtmlText: |
                                ="<div style='width:100%; font-family:Segoe UI; font-size:12px; color:#2d415d; padding:8px; border-bottom:1px solid white;'>

                                  <!-- Linha 1: Motivo + Descri√ß√£o do Motivo + Status -->
                                  <div style='display:flex; gap:20px; flex-wrap:wrap; align-items:center; margin-bottom:2px; justify-content:space-between;'>

                                    <!-- Motivo -->
                                    <div style='flex:1; font-size:12px; font-weight:bold;'>
                                      " & LookUp(bgv_tipos_motivo, ID_Referencia = ThisItem.motivo_id, motivo) & "
                                    </div>

                                    <!-- Descri√ß√£o do Motivo -->
                                    <div style='flex:1;'>
                                      <strong>Descri√ß√£o do Motivo:</strong> " & ThisItem.descricao_motivo_viagem & "
                                    </div>

                                    <!-- Observa√ß√£o -->
                                    <div style='flex:1;'>
                                      <strong>Observa√ß√£o:</strong> " & ThisItem.observacao & "
                                    </div>

                                    <!-- Observa√ß√£o -->
                                    <div style='flex:1;'>
                                      <strong>Centro de Custo:</strong> " & ThisItem.id_contrato & " | " & LookUp(sigd_contratos, ID_Contrato = ThisItem.id_contrato, referencia) & "
                                    </div>

                                    <!-- Status como badge -->
                                    <div style='flex:1; text-align:right;'>
                                      <span style='display:inline-block; background-color:#e8eaf6; color:#1a237e; font-size:11px; padding:4px 8px; border-radius:12px; font-weight:bold;'>
                                        " & ThisItem.status & "
                                      </span>
                                    </div>

                                  </div>

                                  <!-- Linha 2: In√≠cio, Fim, Fora do Prazo, etc. -->
                                  <div style='display:flex; gap:20px; flex-wrap:wrap; line-height:1.2em;'>
                                    <div style='flex:1'><strong>In√≠cio:</strong> " & ThisItem.data_inicio & "</div>
                                    <div style='flex:1'><strong>Fim:</strong> " & ThisItem.data_fim & "</div>
                                    <div style='flex:1'><strong>Adiantamento:</strong> " & If(ThisItem.valor_adiantamento>0, Text(Value(ThisItem.valor_adiantamento), "[$-pt-BR]R$ #.##0,00"), Text(Value(0), "[$-pt-BR]R$ #.##0,00")) & "</div>
                                    <div style='flex:1'><strong>Fora do Prazo:</strong> " & If(ThisItem.solicitado_fora_do_prazo, "‚ö†Ô∏è", "‚ûñ") & "</div>
                                    <div style='flex:1'><strong>Aluguel de Ve√≠culo:</strong> " & If(ThisItem.tipo_transporte_veiculo, "‚úîÔ∏è", "‚úñÔ∏è") & "</div>
                                    <div style='flex:1'><strong>Transporte Rodovi√°rio:</strong> " & If(ThisItem.tipo_transporte_rodoviario, "‚úîÔ∏è", "‚úñÔ∏è") & "</div>
                                    <div style='flex:1'><strong>Transporte A√©reo:</strong> " & If(ThisItem.tipo_transporte_aereo, "‚úîÔ∏è", "‚úñÔ∏è") & "</div>
                                  </div>

                                </div>"
                              OnSelect: =
                              PaddingBottom: =0
                              PaddingTop: =0
                              Width: =Parent.Width
                        - icn_expandir:
                            Control: Classic/Icon@2.5.0
                            Properties:
                              Height: =24
                              Icon: |+
                                =If(varHistoricoExpandido = ThisItem.ID_Referencia, Icon.ChevronUp, Icon.ChevronDown)
                              OnSelect: |+
                                =UpdateContext({
                                    varHistoricoExpandido: If(varHistoricoExpandido = ThisItem.ID_Referencia, Blank(), ThisItem.ID_Referencia),
                                    colRegistroRoteiros: Filter(bgv_roteiros, ID_Referencia = ThisItem.ID_Referencia),
                                    colRegistroViajantes: Filter(bgv_viajantes, ID_Referencia = ThisItem.ID_Referencia)
                                });
                                ClearCollect(
                                    colResumoVisualizacao,
                                    {
                                        ID_Referencia: ThisItem.ID_Referencia,
                                        HtmlCompleto:
                                            "<div style='display:flex; gap:10px; font-family:Segoe UI;'>" &

                                                // üë§ Viajantes
                                                "<div style='flex:1; background-color:#f8f9fa; padding:10px; border-radius:6px;'>" &
                                                    "<div style='font-weight:bold; font-size:16px; color:#2d415d; text-align:center;'>üë§ Viajantes</div>" &
                                                    Concat(
                                                        Filter(bgv_viajantes, ID_Referencia = ThisItem.ID_Referencia),
                                                        "<div style='font-size:12px; color:#2d415d; padding:5px 0; border-bottom:1px solid #e0e0e0;'>" &
                                                            "<div style='font-weight:bold; margin-bottom:4px;'>" & nome & "</div>" &
                                                            "<div style='display:flex; flex-wrap:wrap; justify-content:space-between;'>" &
                                                                "<div style='flex: 1 1 33%;'>üìß " & email & "</div>" &
                                                                "<div style='flex: 1 1 20%;'>üìû " & telefone & "</div>" &
                                                                "<div style='flex: 1 1 46%;'>üè∑Ô∏è Centro de Custo: " & centro_de_custo & "</div>" &
                                                            "</div>" &
                                                        "</div>"
                                                    ) &
                                                "</div>" &

                                                // üöå Locomo√ß√µes
                                                "<div style='flex:1; background-color:#f8f9fa; padding:10px; border-radius:6px;'>" &
                                                    "<div style='font-weight:bold; font-size:16px; color:#2d415d; text-align:center;'>üöå Locomo√ß√µes</div>" &
                                                    Concat(
                                                        Filter(bgv_roteiros, ID_Referencia = ThisItem.ID_Referencia, LookUp(ColTiposOrcamento, ID_Referencia = tipo_orcamento_id).tipo_orcamento = "Locomo√ß√£o"),
                                                        With(
                                                            {
                                                                tipoItem: LookUp(ColTiposOrcamento, ID_Referencia = tipo_orcamento_id, tipo_item)
                                                            },
                                                            "<div style='font-size:12px; color:#2d415d; padding:5px 0; border-bottom:1px solid #e0e0e0;'>" &
                                                                "<div><strong>üöô Tipo:</strong> " & tipoItem & "</div>" &
                                                                "<div style='display:flex; flex-wrap:wrap; justify-content:space-between;'>" &
                                                                    "<div style='flex: 1 1 50%;'>üóìÔ∏è " & If(tipoItem = "Loca√ß√£o de Ve√≠culo", "Retirada:", "Partida:") & " " & Text(data_origem, "[$-pt-BR]dd/mm/yyyy") & "</div>" &
                                                                    "<div style='flex: 1 1 50%;'>üóìÔ∏è " & If(tipoItem = "Loca√ß√£o de Ve√≠culo", "Devolu√ß√£o:", "Chegada:") & " " & Text(data_destino, "[$-pt-BR]dd/mm/yyyy") & "</div>" &
                                                                "</div>" &
                                                                "<div style='display:flex; flex-wrap:wrap; justify-content:space-between;'>" &
                                                                    If(
                                                                        tipoItem = "Loca√ß√£o de Ve√≠culo",
                                                                        "<div style='flex: 1 1 50%;'>üìç Local de Retirada: " & uf_origem & " - " & local_origem & "</div>" &
                                                                        "<div style='flex: 1 1 50%;'>üìç Local de Devolu√ß√£o: " & uf_destino & " - " & local_destino & "</div>",
                                                                        "<div style='flex: 1 1 50%;'>üìç Origem: " & uf_origem & " - " & local_origem & "</div>" &
                                                                        "<div style='flex: 1 1 50%;'>üìç Destino: " & uf_destino & " - " & local_destino & "</div>"
                                                                    ) &
                                                                "</div>" &
                                                            "</div>"
                                                        )
                                                    ) &
                                                "</div>" &

                                                // üè® Hospedagens
                                                "<div style='flex:1; background-color:#f8f9fa; padding:10px; border-radius:6px;'>" &
                                                    "<div style='font-weight:bold; font-size:16px; color:#2d415d; text-align:center;'>üè® Hospedagens</div>" &
                                                    Concat(
                                                        Filter(bgv_roteiros, ID_Referencia = ThisItem.ID_Referencia, LookUp(ColTiposOrcamento, ID_Referencia = tipo_orcamento_id).tipo_orcamento = "Hospedagem"),
                                                        With(
                                                            {
                                                                tipoItem: LookUp(ColTiposOrcamento, ID_Referencia = tipo_orcamento_id, tipo_item)
                                                            },
                                                            "<div style='font-size:12px; color:#2d415d; padding:5px 0;'>
                                                                <strong>üè† Tipo:</strong> " & tipoItem & "
                                                            </div>
                                                            <div style='display: flex; gap: 5px; flex-wrap: wrap; padding: 5px 0;'> 
                                                                <div style='flex: 1 1 50%; font-size:12px;'>üóìÔ∏è Checkin: " & data_origem & " &nbsp;&nbsp;&nbsp; üóìÔ∏è Checkout: " & data_destino & "</div>
                                                                <div style='flex: 1 1 50%; font-size:12px;'>üìç Endere√ßo de Refer√™ncia: " & endereco_da_hospedagem & "</div>
                                                            </div>
                                                            <div style='border-bottom:1px solid #e0e0e0; margin-top:2px;'></div>"
                                                        )
                                                    ) &
                                                "</div>" &

                                            "</div>"
                                    }
                                )
                              Width: =24
                              X: =Parent.Width - Self.Width - 15
                              Y: =htmltxt_historico.Height - Self.Height
